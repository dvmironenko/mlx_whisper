# Техническая спецификация для MLX-Whisper REST API

## Обзор

MLX-Whisper — это высокопроизводительный сервис транскрибации аудио, использующий оптимизированную модель Whisper от Apple (MLX-Whisper) для обработки аудиофайлов на системах macOS с чипами Apple Silicon. Сервис предоставляет как веб-интерфейс, так и REST‑API для преобразования речи в текст с поддержкой нескольких языков и гибкими параметрами обработки.

## Архитектура

### Системные компоненты

1. **FastAPI Web Server**: ядро приложения, обрабатывающее HTTP‑запросы и ответы.
2. **MLX-Whisper Integration**: прямая связь с фреймворком Apple MLX для оптимизированного инференса.
3. **FFmpeg Audio Processing**: преобразование аудиофайлов в требуемый WAV‑формат (16 kHz, моно).
4. **Thread Pool Executor**: управление параллельными задачами транскрипции для оптимального использования ресурсов.
5. **Web Interface**: HTML/JavaScript-фронтенд для удобной загрузки файлов и отображения результатов.

### Технологический стек

- **Backend Framework**: FastAPI (Python 3.8+)
- **MLX Integration**: mlx‑whisper (оптимизированная реализация Whisper от Apple)
- **Audio Processing**: FFmpeg для конвертации форматов
- **Frontend**: HTML, CSS, JavaScript со стилями, похожими на Bootstrap
- **Deployment**: Uvicorn ASGI сервер

### Структура проекта

```
mlx-whisper-api/
├── docs/                   # документация
│   └── technical_specification.md  # эта спецификация
├── models/                 # файлы моделей MLX‑Whisper
│   ├── whisper-tiny/
│   ├── whisper-base/
│   ├── whisper-small/
│   ├── whisper-medium/
│   ├── whisper-turbo/
│   └── whisper-large/
├── src/                    # исходный код
│   ├── main.py             # FastAPI-приложение и логика транскрипции
│   ├── requirements.txt    # зависимости Python
│   ├── static/             # статические ресурсы
│   │   └── style.css       # стили веб‑интерфейса
│   └── templates/          # HTML-шаблоны
│       └── index.html      # веб‑страница
├── tests/                  # тестовые аудиофайлы
│   ├── test.wav
│   └── 2_5258335770527167268.ogg
├── uploads/                # временное хранилище файлов
├── README.md               # инструкция пользователя
└── .gitignore              # игнорируемые файлы Git
```

## Основные функции

### Цепочка обработки аудио

1. **Валидация загрузки файла**
   - проверка расширений (.wav, .mp3, .m4a, .flac, .aac, .ogg, .wma, .webm, .mp4)
   - ограничение размера (максимум 5 ГБ)
   - проверка корректности формата

2. **Преобразование формата**
   - использование FFmpeg для конвертации в WAV (16 kHz, моно)
   - сохранение качества звука и совместимость с моделью Whisper

3. **Транскрипция**
   - поддержка моделей различных размеров (tiny–large, turbo)
   - задачи «transcribe» или «translate»
   - опциональные временные метки слов
   - использование контекста предыдущего текста

4. **Управление результатами**
   - сохранение в текстовые файлы
   - трекинг статуса задач по уникальным идентификаторам
   - метаданные о процессе обработки

### Функции веб‑интерфейса

- загрузка методом drag‑&‑drop
- выбор языка (авто / вручную)
- выбор типа задачи и размера модели
- дополнительные настройки для опытных пользователей
- отображение прогресса и результатов с возможностью скачивания

## Параметры модели и опции

### Основные параметры модели
1. **`model_size`** — размер модели Whisper (tiny, small, medium, large, turbo).
2. **`language`** — код языка (ISO‑639) или автоопределение.
3. **`task`** — «transcribe» или «translate».

### Параметры обработки аудио
1. **`beam_size`** — размер beam search (по умолчанию 5).
2. **`temperature`** — температура выборки (по умолчанию 0.0).
3. **`top_p`** — top‑p sampling для разнообразия вывода.
4. **`max_length`** — максимальная длина генерируемого текста.

### Расширенные опции
1. **`patience`** — терпение beam search.
2. **`length_penalty`** — штраф за длину идеи.
3. **`suppress_tokens`** — токены для подавления.

### Параметры производительности и оборудования
1. **`compute_type`** — fp32 / fp16 / int8.
2. **`threads`** — число CPU‑потоков.
3. **`device`** — cpu / gpu / mps.
4. **`batch_size`** — пакетная обработка нескольких файлов.

### Параметры вывода и форматирования
1. **`word_timestamps`** — включить временные метки слов.
2. **`no_timestamps`** — отключить метки времени.
3. **`highlight`** — выделить текст в выводе.

### Дополнительные функции
1. **`best_of`** — число лучших кандидатов для beam search.
2. **`verbose`** — подробный лог.

## API‑конечные точки

### POST /transcribe

`POST /transcribe`

**Параметры запроса**
(см. раздел 4 для описания опций)

**Формат ответа**
```json
{
  "text": "Распознанный текст",
  "language": "ru",
  "model": "large",
  "task": "transcribe",
  "word_timestamps": true,
  "condition_on_previous_text": true,
  "no_speech_threshold": 0.4,
  "hallucination_silence_threshold": 0.8,
  "segments": [
    {"start":0.0,"end":5.0,"text":"Пример сегмента текста"}
  ],
  "uploaded_file": "job_id_filename.wav",
  "result_file": "job_id_filename.txt",
  "job_id": "уникальный_идентификатор_задачи",
  "duration": 12.34
}
```

### Дополнительные конечные точки

```
GET /health    # проверка работоспособности
GET /models    # список поддерживаемых моделей
GET /job/{job_id} # статус задачи
GET /          # корневой веб‑интерфейс
```

## Технические детали реализации

### Оптимизация памяти

- Чтение больших файлов порциями по 8 КБ.
- Обработка аудио данных сегментами.
- ThreadPoolExecutor с двумя рабочими потоками.
- Уникальные идентификаторы и автоматическая очистка временных файлов.

### Обработка ошибок и логирование

- Валидация входных параметров.
- Отлов ошибок FFmpeg.
- Подробные сообщения об ошибках.
- Структурированное логирование; отслеживание времени выполнения и исключений.

### Сериализация данных

- Преобразование NumPy‑типов в нативные Python.
- Обработка NaN/Infinity.
- Формирование структурированного JSON с метаданными и сегментами.

## Характеристики производительности

### Требования к ресурсам

- macOS с Apple Silicon (M1/M2).
- 8 ГБ ОЗУ минимум.
- Диск для временных файлов ("uploads").
- Оптимизация под нейронный процессор Apple.

### Сравнение производительности моделей

| Модель | Размер | Скорость | Точность |
|--------|--------|----------|----------|
| tiny   | ~39 МБ | Очень быстрая | Низкая |
| base   | ~74 МБ | Быстрая | Удовлетворительная |
| small  | ~249 МБ | Средняя | Хорошая |
| medium | ~769 МБ | Медленная | Высокая |
| turbo  | ~1.4 ГБ | Очень быстрая | Очень высокая |
| large  | ~3.1 ГБ | Медленная | Отличная |

### Цепочка обработки

1. Загрузка файла (по частям).
2. Конвертация WAV через FFmpeg.
3. Инференс выбранной модели.
4. Сериализация в JSON.
5. Создание текстового файла и трекинг задачи.

## Соображения безопасности

- Проверка расширений и размера файла.
- Очистка входных данных.
- Уникальные идентификаторы и безопасные пути.
- Без аутентификации (локальное использование).
- Ограничение частоты запросов через пул потоков.

## Развертывание

### Системные предварительные условия

- macOS с Apple Silicon.
- Python 3.8+.
- Установленный FFmpeg.
- 8 ГБ ОЗУ рекомендовано.

### Шаги установки

1. `git clone ... && cd mlx-whisper`
2. `python -m venv .venv && source .venv/bin/activate`
3. `pip install -r src/requirements.txt`
4. Загрузить модели в `models/whisper-*`.
5. `python src/main.py`

### Производственные соображения

- Gunicorn вместо Uvicorn.
- Аутентификация для публичного доступа.
- Настройка логирования и балансировка нагрузки.

## Тестирование и проверка

### Стратегия тестирования

- Модульные тесты для функций и параметров.
- Интеграционные тесты полного цикла.
- Тесты на нагрузку и память.

### Тестовые файлы

- `tests/test.wav`
- `tests/2_5258335770527167268.ogg`

## Устранение неполадок

1. FFmpeg не найден — установить через Homebrew.
2. Модели отсутствуют — загрузить с Hugging Face.
3. Проблемы с памятью — использовать более мелкие модели.
4. Неподдерживаемый формат — убедиться в поддерживаемом расширении.

## Будущие улучшения

1. **Поддержка многоязычности**: Расширить поддержку языков за пределы русского/английского
2. **Пакетная обработка**: Добавить возможность одновременной обработки нескольких файлов
3. **Улучшенный веб‑интерфейс**: Улучшить UI с индикаторами прогресса в реальном времени
4. **Аутентификация API**: Реализовать токен‑базированную аутентификацию для безопасных развертываний
5. **Кэширование моделей**: Оптимизировать стратегии загрузки и кэширования моделей
6. **Контейнеризация**: Предоставить поддержку Docker для упрощенного развертывания

## Поддержка и обслуживание

1. **Обновления моделей**: Регулярные обновления моделей MLX‑Whisper с Hugging Face
2. **Патчи безопасности**: Поддерживать зависимости актуальными с патчами безопасности
3. **Мониторинг производительности**: Отслеживать системные ресурсы и корректировать настройки пула потоков
4. **Обновления документации**: Держать техническую документацию актуальной с изменениями кода

## Соответствие стандартам

### Стандарты разработки

- Стили кодирования PEP 8 для Python
- Аннотации типов для всех параметров функций и возвращаемых значений
- Правильная обработка исключений с HTTP‑кодами статуса
- Асинхронные/ожидающие паттерны для операций ввода‑вывода

### Стандарты данных

- Формат JSON для всех ответов API
- Кодировка UTF‑8 для текстовых файлов
- Стандартные форматы временных меток в сегментах
- Последовательные соглашения по именованию для идентификаторов задач

## Ссылки

1. [MLX‑Whisper GitHub](https://github.com/ml-explore/mlx-whisper)
2. [Фреймворк Apple MLX](https://github.com/ml-explore/mlx)
3. [Документация FastAPI](https://fastapi.tiangolo.com/)
4. [Документация FFmpeg](https://ffmpeg.org/documentation.html)
5. [OpenAI Whisper Paper](https://arxiv.org/abs/2212.04356)
