# MLX-Whisper Web Transcription Service

## Обзор приложения

Приложение представляет собой веб-сервис для транскрибации и перевода аудио с использованием оптимизированной модели Whisper от Apple (MLX-Whisper). Оно предоставляет как веб-интерфейс, так и REST API для преобразования речи в текст с поддержкой нескольких языков и гибких параметров обработки.

## Основные компоненты приложения

### 1. Главное FastAPI-приложение (`src/main.py`)
- Основная точка входа, построенная на FastAPI
- Обработка HTTP-запросов и ответов для операций транскрипции
- Интеграция с моделью MLX-Whisper для транскрибации
- Обработка цепочки файлов с использованием FFmpeg для конвертации в WAV (16 кГц, моно)
- Оптимизация памяти с использованием потоков

### 2. Веб-интерфейс
- HTML шаблон (`src/templates/index.html`) с встроенным JavaScript
- CSS стили (`src/static/style.css`) для отображения интерфейса
- Предоставляет удобный веб-интерфейс для загрузки аудиофайлов и обработки

### 3. Архитектура обработки аудио
- Поддержка различных форматов (WAV, MP3, M4A, FLAC, AAC, OGG, WMA, WEBM, MP4)
- Использование FFmpeg для автоматической конвертации в WAV формат
- Поддержка нескольких размеров модели Whisper (tiny, base, small, medium, turbo, large)
- Оптимизация памяти через обработку файлов по частям

## Технические особенности

### Управление памятью
- Обработка файлов частями по 8 КБ для предотвращения переполнения памяти
- Использование ThreadPoolExecutor с ограниченным количеством рабочих потоков (2) для тяжелых задач транскрипции
- Автоматическая очистка временных файлов после обработки

### Обработка ошибок и надежность
- Полная обработка ошибок с соответствующими HTTP-кодами состояния
- Безопасное удаление временных файлов при ошибках обработки
- JSON сериализация с особым подходом к numpy типам и недопустимым значениям float

### REST API Endpoints
- `/` - веб-интерфейс, предоставляющий HTML шаблон
- `/api/v1/health` - проверка состояния сервиса
- `/api/v1/models` - список поддерживаемых моделей
- `/api/v1/job/{job_id}` - проверка статуса задачи транскрипции
- `/api/v1/transcribe` - основная точка входа для транскрибации аудиофайлов

### Особенности веб-интерфейса
- Интуитивно понятная форма с выбором языка, типом задачи и размером модели
- Параметры управления: включение временных меток, контекстная обработка и пороговые значения
- Четкое отображение результатов транскрибации с возможностью скачивания
- Различные варианты скачивания: текст, сегменты (с временными метками) или комбинированные файлы

## Структура кода

```
src/
├── main.py                   # FastAPI приложение (входная точка)
├── config.py                 # Конфигурация через environment variables
├── logging_config.py         # Конфигурация логирования (устаревший, использовать config.py)
├── models/
│   ├── __init__.py
│   └── transcription.py      # Логика транскрипции и конвертация
├── api/
│   ├── __init__.py
│   ├── router.py             # FastAPI роуты
│   └── dependencies.py       # Зависимости (auth, auth check)
└── utils/
    ├── __init__.py
    ├── audio.py              # FFmpeg конвертация
    └── files.py              # Работа с файлами

tests/
├── test.py                   # Unit-тесты
└── test.wav                  # Тестовый аудиофайл

models/                       # Каталог моделей Whisper
uploads/                      # Временное хранилище загруженных файлов
results/                      # Сохраненные результаты транскрипции
logs/                         # Логи приложения (app.log, error.log)
```

### Ключевые модули

#### `src/config.py` - Конфигурация приложения
Конфигурация через environment variables:
- `MLX_WHISPER_HOST` - хост сервера (по умолчанию: 0.0.0.0)
- `MLX_WHISPER_PORT` - порт сервера (по умолчанию: 8801)
- `MLX_WHISPER_DEBUG` - режим отладки (по умолчанию: false)
- `MAX_FILE_SIZE_MB` - максимальный размер файла в МБ (по умолчанию: 500)
- `CHUNK_SIZE_KB` - размер chunk для чтения файлов в КБ (по умолчанию: 8)
- `CONVERSION_TIMEOUT` - таймаут конвертации в секундах (по умолчанию: 600)
- `TRANSCRIPTION_TIMEOUT` - таймаут транскрипции в секундах (по умолчанию: 3600)
- `MODELS_DIR` - путь к каталогу моделей (по умолчанию: models)
- `RESULTS_DIR` - путь к каталогу результатов (по умолчанию: results)
- `RESULTS_RETENTION_DAYS` - срок хранения результатов в днях (по умолчанию: 30)
- `MLX_WHISPER_API_KEY` - API ключ для аутентификации
- `LOGS_DIR` - путь к каталогу логов (по умолчанию: logs)
- `LOG_LEVEL` - уровень логирования (по умолчанию: INFO)

#### `src/logging_config.py` - Логирование
Конфигурация логирования с ротацией файлов:
- `app.log` - основной файл логов (10MB, 5 резервных копий)
- `error.log` - файл ошибок (10MB, 5 резервных копий)
- Логи выводятся в stdout и файлы одновременно

#### `src/models/transcription.py` - Бизнес-логика
Основные функции транскрипции:
- `transcribe_audio()` - выполнение транскрипции
- `convert_numpy_types()` - конвертация numpy типов для JSON
- `sanitize_for_json()` - очистка данных для JSON

#### `src/utils/audio.py` - Работа с аудио
Утилиты для обработки аудио:
- `convert_to_wav()` - конвертация в WAV (16kHz, mono)
- `validate_audio_file()` - валидация аудиофайла
- `get_audio_duration()` - получение длительности

#### `src/utils/files.py` - Работа с файлами
Утилиты для работы с файлами:
- `generate_unique_filename()` - генерация уникального имени
- `validate_file_size()` - проверка размера файла
- `validate_file_extension()` - проверка расширения
- `chunked_read()` - потоковое чтение файла
- `delete_file()` - удаление файла
- `cleanup_old_files()` - очистка старых файлов

#### `src/api/router.py` - API роуты
FastAPI эндпоинты:
- `POST /api/v1/transcribe` - транскрипция аудио
- `GET /api/v1/health` - проверка состояния
- `GET /api/v1/models` - список моделей
- `GET /api/v1/jobs/{job_id}` - статус задачи

#### `src/api/dependencies.py` - Зависимости API
Функции для защиты эндпоинтов:
- `verify_api_key()` - проверка API ключа
- `get_current_api_key()` - получение текущего ключа

## Ключевые функции

### Поддержка форматов аудио
Приложение поддерживает широкий спектр аудиоформатов:
- WAV, MP3, M4A, FLAC, AAC, OGG, WMA, WEBM, MP4

### Модели Whisper
Поддерживаются различные размеры моделей:
- tiny (маленькая модель)
- base (базовая модель)
- small (малая модель)
- medium (средняя модель)
- turbo (турбо модель)
- large (большая модель)

### Оптимизация производительности
- Использование ThreadPoolExecutor для параллельной обработки задач
- Частичная обработка файлов для экономии памяти
- Автоматическая очистка временных файлов

### Безопасность и надежность
- Полная обработка ошибок с соответствующими HTTP-статусами
- Безопасное удаление временных файлов при ошибках
- JSON сериализация с особым подходом к специальным значениям
- Опциональная аутентификация через API ключ

## Развертывание и запуск

### Установка зависимостей
```bash
# Создание и активация виртуального окружения
python -m venv .venv
source .venv/bin/activate

# Установка зависимостей
pip install -r src/requirements.txt
```

### Запуск приложения
```bash
# Скопировать .env.example в .env и настроить параметры
cp .env.example .env

# Запуск сервера
python src/main.py

# Сервер будет запущен на http://localhost:8801
```

### Конфигурация через .env файл
Создайте `.env` файл в корне проекта:
```bash
MLX_WHISPER_HOST=0.0.0.0
MLX_WHISPER_PORT=8801
MLX_WHISPER_DEBUG=false
MAX_FILE_SIZE_MB=500
CHUNK_SIZE_KB=8
CONVERSION_TIMEOUT=600
TRANSCRIPTION_TIMEOUT=3600
MODELS_DIR=models
RESULTS_DIR=results
RESULTS_RETENTION_DAYS=30
MLX_WHISPER_API_KEY=
LOGS_DIR=logs
LOG_LEVEL=INFO
```

### Тестирование
```bash
# Ручное тестирование с помощью curl
curl -X POST "http://localhost:8801/api/v1/transcribe" \
  -F "file=@tests/test.wav" \
  -F "language=ru"

# Использование веб-интерфейса
# Перейдите по адресу http://localhost:8801 в браузере

# Запуск unit-тестов
pytest tests/ -v
```

## Архитектура API

### Основные эндпоинты:
1. `/` - Возвращает веб-интерфейс
2. `/api/v1/health` - Проверяет состояние сервиса
3. `/api/v1/models` - Возвращает список поддерживаемых моделей
4. `/api/v1/job/{job_id}` - Проверяет статус задачи транскрипции
5. `/api/v1/transcribe` - Основная точка входа для транскрипции аудиофайлов

### Параметры транскрибации:
- `file` - Аудиофайл для обработки
- `language` - Язык (auto, ru, en и др.)
- `task` - Тип задачи (transcribe/translate)
- `model` - Размер модели (tiny, base, small, medium, turbo, large)
- `word_timestamps` - Включение временных меток для слов
- `condition_on_previous_text` - Контекстная обработка
- `no_speech_threshold` - Пороговое значение для фильтрации
- `hallucination_silence_threshold` - Пороговое значение для фильтрации

## CI/CD пайплайн

Приложение использует GitHub Actions для автоматического тестирования:

```yaml
# .github/workflows/tests.yml
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: pip install pytest pytest-asyncio
      - name: Run unit tests
        run: pytest tests/ -v

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run linters
        run: black --check src/ tests/
```

## Заключение

Приложение предоставляет надежное, масштабируемое решение для транскрипции аудио с интуитивно понятным веб-интерфейсом и правильной обработкой ошибок. Использование MLX-Whisper обеспечивает оптимизированные характеристики производительности от Apple, при этом сохраняя доступность через веб-интерфейс.

### Сравнение с предыдущей версией

| Характеристика | До рефакторинга | После рефакторинга |
|----------------|-----------------|-------------------|
| main.py строк | 569 | < 50 |
| Модульность | Единый файл | 10+ модулей |
| Конфигурация | Хардкод | Environment variables |
| Логирование | Только stdout | Файлы + ротация |
| Тесты | 3 базовых | 5+ unit-тестов |
| CI/CD | Отсутствует | GitHub Actions |
